<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Game Card Factory — Law 5 Referee</title>

  <link rel="icon" href="images/favicon.svg" type="image/svg+xml" />
<link rel="stylesheet" href="/css/style.css">

<link rel="stylesheet" href="css/fast-card-factory.css">
<link rel="stylesheet" href="css/mapping-ui.css">

  <!-- PDF + FileSaver + JSZip -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>

<body class="admin-page">

<header>
  <h1>Law Five Referee</h1>
  <style>
  /* Force Law5Ref header styling on app pages */
  header {
    background-color: var(--green) !important;
    color: #ffffff !important;
    padding: 15px 0 !important;
    text-align: center !important;
  }

  header h1 {
    margin: 0 !important;
    font-size: 1.8em !important;

    /* Fix invisible title caused by app CSS */
    color: #ffffff !important;
    -webkit-text-fill-color: #ffffff !important;
    opacity: 1 !important;
    text-shadow: none !important;
  }

  header nav {
    margin-top: 8px !important;
  }

  header nav a {
    color: #ffffff !important;
    text-decoration: none !important;
    margin: 0 12px !important;
    font-weight: 500 !important;
    transition: opacity 0.3s ease !important;
  }

  header nav a:hover {
    opacity: 0.8 !important;
  }
</style>
  <nav>
    <a href="/index.html">Home</a>
    <a href="/penalty-shootout.html">Penalty Shoot-out</a>
    <a href="/quicklook-today.html">QuickLook Today</a>
    <a href="/apps/game-card-factory/index.html">Game Card Factory</a>
     <a href="/apps/Lineup-card-factory/index.html">Lineup Card Factory</a>
    <a href="/downloads.html">Downloads</a>

    <a href="/contact.html">Contact</a>
    <a href="/privacy.html">Privacy</a>
  </nav>
</header>

<div class="container">

  <h1>Game Card Factory</h1>
  <p class="intro-blurb">
    <strong>Paste a schedule, preview game cards, and generate match report PDFs without a database.</strong>
  </p>

  <!-- ============================================================
       PARSER HELP
  ============================================================ -->
  <div class="parser-help-wrapper">
    <div class="parser-help-body" id="parserHelpBody">
      <h4>Available Extractors</h4>

      <div class="parser-help-item"><strong>Text Advanced</strong><br>12-line AYSO block format.</div>
      <div class="parser-help-item"><strong>Arbiter GameView</strong><br>Paste full ArbiterSports “Game Details”.</div>
      <div class="parser-help-item"><strong>Arbiter Email</strong><br>Paste entire ArbiterSports email notification.</div>
      <div class="parser-help-item"><strong>Google Sheets / CSV</strong><br>One row per game.</div>
      <div class="parser-help-item"><strong>Compact</strong><br>Single-line formats.</div>
      <div class="parser-help-item"><strong>AYSO Schedule</strong><br>Region spreadsheet formats.</div>
    </div>
  </div>

  <!-- ============================================================
       1. PASTE SCHEDULE TEXT
  ============================================================ -->

  <section class="collapsible-panel" id="section-1">
  <button type="button" class="collapsible-header">
    <span class="collapsible-icon">+</span>
    <span class="collapsible-title">1. Paste Schedule Text</span>
  </button>

  <p class="section-subtitle" id="status-section-1">
    Paste schedule text and select a game extractor.
  </p>

  <div class="collapsible-body">

    <p class="parser-label">
      Extractor: <span id="parserName"></span>
    </p>

<div class="mapping-actions">

  <!-- Open Mapping Panel button (restored) -->
  <button id="openMappingPanelBtn" class="btn">Define Mapping</button>

  <!-- Save / Load Mapping Profile -->
  <button id="saveMappingProfile" class="btn">Save Mapping</button>
  <button id="exportMappingProfile" class="secondary">Export…</button>
  <button id="importMappingProfile" class="secondary">Import…</button>
  <button id="resetMappingProfile" class="secondary">Reset</button>

  <!-- hidden file input used by Import -->
  <input id="importMappingFileInput" type="file" accept="application/json" class="hidden" />

</div>

    <!-- Carousel -->
    <div class="parser-carousel-wrapper">
      <button class="parser-arrow left" id="prevParser" type="button">‹</button>

      <div class="parser-info">
        <div id="parserNameCarousel" class="parser-name"></div>
        <div id="parserDescription" class="parser-description"></div>
      </div>

      <button class="parser-arrow right" id="nextParser" type="button">›</button>
    </div>
	<!-- Saved Schedules -->
	<div class="saved-schedules-section">
	  <label for="scheduleSelect">Saved Schedules:</label>
	  <div class="saved-schedules-controls">
		<select id="scheduleSelect"></select>
		<button id="loadScheduleBtn" class="btn">Load</button>
		<button id="deleteScheduleBtn" class="btn secondary">Delete</button>
		<button id="renameScheduleBtn" class="btn">Rename</button>
	  </div>
	</div>
    <textarea id="rawInput" class="import-textarea"
      placeholder="Paste schedule text here"></textarea>

    <div class="parse-row">
      <div class="left-buttons">
        <button id="parseBtn" class="btn">Extract Games</button>
        <button id="clearBtn" class="secondary">Clear</button>
      </div>
      <span id="parseStatus" class="parse-status"></span>
    </div>

  </div>
</section>
<!-- Shared Parser Editor Modal -->
<div id="parserManagerModal" class="modal-backdrop hidden">
  <div class="modal-content">
    <h2 id="parserManagerTitle">Parser Editor</h2>

    <label>Parser Name</label>
    <input id="parserNameInput" type="text">

    <label>Description</label>
    <input id="parserDescInput" type="text">

    <label>Rules / Code</label>
    <textarea id="parserRulesInput" rows="8"
              placeholder="// Enter mapping rules or JS code"></textarea>

    <div class="modal-buttons">
      <button id="saveParserBtn" class="btn">Save Parser</button>
      <button id="cancelParserBtn" class="btn secondary">Cancel</button>
    </div>
  </div>
</div>

  <!-- ============================================================
       2. SELECT & FILTER GAMES
  ============================================================ -->
  <section class="collapsible-panel" id="section-2">
    <button type="button" class="collapsible-header">
      <span class="collapsible-icon">+</span>
      <span class="collapsible-title">2. Select & Filter Games</span>
    </button>

    <p class="section-subtitle" id="status-section-2">
      Build rules to select or deselect games.
    </p>

    <div class="collapsible-body">

      <div class="filter-rules-panel">

        <div class="filter-global-actions-row">
          <button id="filterSelectAllGamesBtn" class="secondary">Select All Games</button>
          <button id="filterDeselectAllGamesBtn" class="secondary">Deselect All Games</button>
        </div>

        <div class="filter-rules-header">
          <span>If</span>
          <select id="filterMatchMode" class="filter-pill-select">
            <option value="any">any</option>
            <option value="all">all</option>
          </select>
          <span>conditions are met:</span>
        </div>

        <div id="filterRulesContainer" class="filter-rules-container"></div>
		<div class="filter-presets-row">
		  <label class="filter-presets-label" for="filterPresetSelect">Saved Filters:</label>
		  <select id="filterPresetSelect" class="filter-pill-select">
			<option value="">(none)</option>
		  </select>
		  <button id="filterSavePresetBtn" class="secondary">Save…</button>
		  <button id="filterDeletePresetBtn" class="secondary">Delete</button>
		</div>
        <div class="filter-actions-row">
          <button id="filterSelectBtn" class="btn">Select Matching</button>
          <button id="filterDeselectBtn" class="secondary">Deselect Matching</button>
          <button id="filterClearBtn" class="secondary">Clear Rules</button>
        </div>

      </div>
      <select id="refereeNameVocabulary" class="hidden"></select>
      <select id="teamNameVocabulary" class="hidden"></select>

    </div>
  </section>

  <!-- ============================================================
       3. BULK EDIT (CLEAN)
  ============================================================ -->
 <!-- ============================================================
     3. BULK EDIT (CLEAN + FIXED)
============================================================ -->
<section class="collapsible-panel" id="section-3">

  <button type="button" class="collapsible-header">
    <span class="collapsible-icon">+</span>
    <span class="collapsible-title">3. Bulk Edit Selected Cards</span>
  </button>

  <p class="section-subtitle" id="status-section-3">
    Edit fields in ALL selected game cards at once.
  </p>

  <div class="collapsible-body macos-bulk-body">

    <div class="macos-help-line">
      Changes apply only to <strong>selected games</strong>.
    </div>

    <div class="macos-bulk-panel">

      <!-- NOTES -->
      <div class="macos-row">
        <label>Notes</label>

        <select id="bulkNotesUnified" class="macos-select" style="margin-bottom:8px;">
          <option value="">— choose or type below —</option>
        </select>

        <input id="bulkGameInfoInput"
               class="macos-input"
               type="text"
               placeholder="Type a custom note…">
      </div>

      <!-- DATE + DIVISION -->
      <div class="macos-row two-columns">
        <div class="column">
          <label>Date</label>
          <input id="bulkDate" type="date" class="macos-input">
        </div>

        <div class="column">
          <label>Age/Division</label>
          <input id="bulkDivision" type="text" class="macos-input">
        </div>
      </div>

      <!-- LOCATION + FIELD -->
      <div class="macos-row two-columns">
        <div class="column">
          <label>Location</label>
          <input id="bulkLocation" type="text" class="macos-input">
        </div>

        <div class="column">
          <label>Field</label>
          <input id="bulkField" type="text" class="macos-input">
        </div>
      </div>

      <!-- COLORS -->
      <div class="macos-row two-columns">
        <div class="column">
          <label>Home Colors</label>
          <input id="bulkHomeColors" type="text" class="macos-input">
        </div>

        <div class="column">
          <label>Away Colors</label>
          <input id="bulkAwayColors" type="text" class="macos-input">
        </div>
      </div>

      <!-- ASSIGNER -->
      <div class="macos-row">
        <label>Choose a previous Assigner (optional)</label>
        <select id="bulkAssignerHistory" class="macos-select" style="margin-bottom:8px;">
          <option value="">— Choose —</option>
        </select>

        <label>Assigner</label>
        <div class="macos-control-pair">
          <input id="bulkAssignName"  class="macos-input" type="text" placeholder="Name">
          <input id="bulkAssignPhone" class="macos-input" type="text" placeholder="Phone">
          <input id="bulkAssignEmail" class="macos-input" type="text" placeholder="Email">
        </div>
      </div>

      <!-- PAYER -->
      <div class="macos-row">
        <label>Payer</label>
        <div class="macos-control-pair">
          <input id="bulkPayerName"  class="macos-input" type="text" placeholder="Name">
          <input id="bulkPayerPhone" class="macos-input" type="text" placeholder="Phone">
          <input id="bulkPayerEmail" class="macos-input" type="text" placeholder="Email">
        </div>
      </div>

      <div class="macos-button-row">
        <button id="applyBulkEditBtn" class="btn">Apply to Selected Games</button>
        <button id="clearBulkEditBtn" class="secondary">Clear Bulk Edit Fields</button>
      </div>

    </div>

  </div>
</section>
  <!-- ============================================================
       4. GAME CARD PREVIEW
  ============================================================ -->
  <section class="collapsible-panel" id="section-4">
    <button type="button" class="collapsible-header">
      <span class="collapsible-icon">+</span>
      <span class="collapsible-title">4. Game Card Preview</span>
    </button>

    <p class="section-subtitle" id="status-section-4">0 games detected</p>

    <div class="collapsible-body">
      <div class="preview-controls">
		<div class="filter-btn-row">
		  <button id="selectAllCardsBtn" class="rule-btn-main">Select All Games</button>
		  <button id="deselectAllCardsBtn" class="rule-btn-main">Deselect All Games</button>
		  <button id="deleteSelectedGamesBtn" class="rule-btn-main">Delete Selected</button>
		</div>
        <div class="selected-count">Selected: <span id="selectedCount">0</span></div>
      </div>

      <div id="cardsContainer" class="cards-container"></div>
    </div>
  </section>

  <!-- ============================================================
       5. TEMPLATE SELECTOR
  ============================================================ -->
  <section class="collapsible-panel" id="section-5">
    <button type="button" class="collapsible-header">
      <span class="collapsible-icon">+</span>
      <span class="collapsible-title">5. Choose Report Card Template</span>
    </button>

    <p class="section-subtitle">Choose a report card template.</p>

    <div class="collapsible-body">

      <div class="template-carousel-wrapper">
        <button id="prevTemplate" class="carousel-arrow left">&lsaquo;</button>
        <div class="template-carousel">
          <div class="template-slide active">
            <img id="templateImage" src="templates/Custom-Blank-Card.png" alt="Template Preview" />
          </div>
        </div>
        <button id="nextTemplate" class="carousel-arrow right">&rsaquo;</button>
      </div>

      <p id="templateName" class="template-name">Custom-Blank-Card</p>
      <p id="templateStatus" class="template-status">Template 1 of 1</p>

    </div>
  </section>

  <!-- ============================================================
       6. GENERATE PDF (CLEAN)
  ============================================================ -->
  <section class="collapsible-panel" id="section-6">

    <button type="button" class="collapsible-header">
      <span class="collapsible-icon">+</span>
      <span class="collapsible-title">6. Generate PDF Game Cards</span>
    </button>

    <p class="section-subtitle">
      Print selected cards individually or on a letter-size template.
    </p>

    <div class="collapsible-body macos-bulk-body">

      <div class="macos-bulk-panel">

        <div class="macos-row two-columns">
          <div class="column">
            <label>PDF Output</label>
            <button id="generateCombinedBtn" class="btn fullwidth">Combined PDF</button>
          </div>

          <div class="column">
            <label class="invisible-label">.</label>
            <button id="generateIndividualBtn" class="secondary fullwidth">Individual PDFs</button>
          </div>
        </div>

        <p id="generateStatus" class="status-line"></p>
		<!-- PDF progress (shown while generating PDFs) -->
		<div id="pdfProgressWrap" class="pdf-progress hidden" aria-live="polite">
		  <div class="pdf-progress-row">
			<div id="pdfSpinner" class="pdf-spinner" aria-hidden="true"></div>
			<div id="pdfProgressText" class="pdf-progress-text">Working…</div>
		  </div>

		  <div id="pdfProgressBarWrap" class="pdf-progressbar-wrap hidden">
			<div class="pdf-progressbar">
			  <div id="pdfProgressFill" class="pdf-progressbar-fill" style="width:0%"></div>
			</div>
			<div id="pdfProgressCount" class="pdf-progress-count">0 / 0</div>
		  </div>
		</div>
        <div class="export-subpanel macos-subcard">
          <label>Export Extracted Data</label>
          <div class="export-row">
            <button id="exportJsonBtn" class="secondary fullwidth">Export JSON</button>
            <button id="exportCsvBtn"  class="secondary fullwidth">Export CSV</button>
          </div>
        </div>

        <button id="toggleHistoryManager" class="secondary fullwidth history-btn">
          Manage History
        </button>

      </div>
    </div>
  </section>

</div> <!-- /.container -->

<!-- ============================================================
     HISTORY MODAL
============================================================ -->
<div id="historyModal" class="modal-overlay" style="display:none;">
  <div class="modal-window">

    <h2>Manage Saved History</h2>

    <h3>Notes History</h3>
    <div id="notesHistoryList"></div>

    <h3>Assigner History</h3>
    <div id="assignerHistoryList"></div>

    <button id="closeHistoryModal" class="secondary" style="margin-top:16px;">
      Close
    </button>

  </div>
</div>
<!-- =======================================================
     EDIT MODAL (Modern macOS-style)
======================================================= -->
<div id="editModal" class="modal-overlay" style="display:none;">
  <div class="modal-window edit-window">

    <h2 class="modal-title">Edit Game</h2>

    <div id="editModalBody" class="edit-grid">

      <!-- The JS will inject all rows here -->

    </div>

    <div class="edit-modal-buttons">
      <button id="saveEditBtn" class="btn">Save Changes</button>
      <button id="cancelEditBtn" class="secondary">Cancel</button>
    </div>

  </div>
</div>
<!-- ================================
     GENERIC MAPPING UI PANEL
================================ -->
<div id="genericMappingPanel" class="mapping-panel hidden">
  <h3>Column Mapping</h3>
  <p>Select which input column corresponds to each game field.</p>

  <div id="mappingTable"></div>

  <div class="mapping-buttons">
    <button id="saveMappingProfile" class="btn btn-primary">Save Mapping</button>
    <button id="cancelMappingProfile" class="btn">Cancel</button>
  </div>
</div>

<footer>
  <p>© 2025 Law Five Referee.	 Site design and build assistance by <a href="https://chat.openai.com/" target="_blank">ChatGPT</a></p>
</footer>
<script type="module" src="js/module-loader.js"></script>
<script data-goatcounter="https://law5ref.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>
